define(["jquery","underscore","backbone","js/lib/q","js/lib/readme","pages/spark-survey/assessApi","pages/spark-survey/util/abUtils","pages/spark/app","i18n!pages/spark/views/template/nls/sidebar","pages/spark/views/template/sidebar.html","spark/app/signature/js/signature_track","bundles/assess/assessmentTypes/sparkSurveyQuestions/sparkSurveyQuestionsSessionModel"],function($,_,Backbone,Q,Readme,assessApi,AbUtils,Coursera,_t,template,SigtrackFunctions,SparkSurveyQuestionsSessionModel){var sidebar=Backbone.View.extend({name:"sidebar",className:"coursera-sidebar",attributes:{role:"menubar"},options:{},events:{"click .in-class-qqs-tab":"dismissPopup"},initialize:function(){},determineQuickQuestionTabPresence:function(){var self=this,endsWith=function(string,suffix){return-1!==string.indexOf(suffix,string.length-suffix.length)};if(AbUtils.userAndSessionHaveSparkSurveyQuestions())if(!endsWith(window.location.pathname,"/questions")){var model=new SparkSurveyQuestionsSessionModel({classId:Coursera.course.id});model.options=_(model.options||{}).extend({api:assessApi}),model.on("change:state",function(){var state=model.get("state");if("loading"!=state)self.options.questionsLeft="question"==state,self.trigger("qqsDetermined")},this),model.fetch()}else self.options.questionsLeft=!0,self.trigger("qqsDetermined");else self.options.questionsLeft=!1,self.trigger("qqsDetermined")},dismissPopup:function(){$(".in-class-qqs-announcement [data-readme-close]")[0].click()},renderAfterQuickQuestionsTabDetermined:function(renderQuickQuestionsTab,renderCallout){this.$el.html(template({_t:_t,course:Coursera.course,user:Coursera.user,navbar:Coursera.navbar,config:Coursera.config,url:encodeURIComponent(decodeURIComponent(window.location.href)),hasSparkSurveyQuestions:renderQuickQuestionsTab,hasSparkSurveyQuestionsCallout:renderCallout})),this.updateSidebar(),SigtrackFunctions.addLastChanceModalInteraction(this.$el),this.trigger("sidebarRendered")},render:function(){return Coursera.course.on("dateSet",this.determineQuickQuestionTabPresence,this),Coursera.course.on("datesNotFound",function(){this.renderAfterQuickQuestionsTabDetermined(!1,!1)},this),this.on("qqsDetermined",function(){this.renderAfterQuickQuestionsTabDetermined(this.options.questionsLeft,AbUtils.showTabCallout())}),this.on("sidebarRendered",function(){if(AbUtils.showTabCallout())new Readme(".in-class-qqs-announcement [data-readme]")}),AbUtils.setSessionStartAndEndDates(),this},updateSidebar:function(){function markLink(query){if(foundActiveLink)return;var matches=[];if($navbar.find(query).each(function(){matches.push($(this).parent()),foundActiveLink=!0}),1==matches.length)if(foundActiveLink=!0,-1==window.location.href.indexOf("/search?q"))matches[0].addClass("active"),matches[0].find("a").append('<span class="course-navbar-selected-marker">(selected)</span>')}this.$el.find(".course-navbar-container li").removeClass("active"),this.$el.find(".course-navbar-container li").remove(".course-navbar-selected-marker");var $navbar=this.$el.find(".course-navbar-container li"),foundActiveLink=!1;markLink('a[href="'+window.location.pathname+"/index"+window.location.search+'"]'),markLink('a[href="'+window.location.pathname+window.location.search+'"]'),markLink('a[href="'+window.location.href+'"]'),markLink('a[href="'+window.location.pathname+'"]'),markLink('a[href="'+window.location.href+'/index"]'),markLink('a[href="'+window.location.pathname+'/index"]'),markLink('a[href^="'+window.location.href.split("?")[0]+'"]')}});return sidebar});