define(["underscore","js/lib/coursera.ab","js/lib/q","js/json/classQuickQuestionsPilot","pages/spark/app","pages/spark-survey/catalogApi"],function(_,AB,Q,pilotSessions,Coursera,catalogApi){var AbUtils={isSessionWithSparkSurveyQuestions:function(){return Coursera.course.get("id")in pilotSessions},isTestSubject:function(){return!Coursera.user.canAccessAdmin()&&!Coursera.user.can("bulk_data_low_risk")},userAndSessionHaveSparkSurveyQuestions:function(){var startDate=Coursera.course.get("startDate"),endDate=Coursera.course.get("endDate");if(startDate&&endDate&&this.isSessionWithSparkSurveyQuestions()&&this.isTestSubject()){var sessionId=Coursera.course.get("id"),experiment=AB.user.getExperiment("in_class_qqs"),expAbTest=experiment.getChosenVariant();if("no_qqs"!=expAbTest){var oneHourMilliseconds=36e5,oneDayMilliseconds=24*oneHourMilliseconds,now=new Date,utcNow=new Date(now.getUTCFullYear(),now.getUTCMonth(),now.getUTCDate(),now.getUTCHours(),now.getUTCMinutes()),pdtNow=utcNow.getTime()-7*oneHourMilliseconds,start=startDate.getTime(),end=endDate.getTime(),totalDays=(end-(start-oneDayMilliseconds))/oneDayMilliseconds,totalWeeks=Math.floor(totalDays/7),currentDay=Math.ceil((pdtNow-9*oneHourMilliseconds-start)/oneDayMilliseconds),currentWeek=Math.ceil(currentDay/7),totalBuckets=experiment.weights.length-1,myBucketNum=parseInt(expAbTest.split("_")[1],10);return currentWeek-2>=myBucketNum/totalBuckets*(totalWeeks-2)}}return!1},showFeedbackData:function(){if(this.isTestSubject()){var experiment=AB.user.getExperiment("in_class_qqs_feedback"),expAbTest=experiment.getChosenVariant();return"yes_feedback"==expAbTest}return!0},getSessionStartAndEndDates:function(){var sessionId=Coursera.course.get("id");return Q(catalogApi.get("sessions?ids="+sessionId+"&fields=startDate,endDate"))},setSessionStartAndEndDates:function(){if(!Coursera.course.get("startDate")||!Coursera.course.get("endDate")){var self=this,oneDayMilliseconds=864e5,oneWeekMilliseconds=7*oneDayMilliseconds,sessionId=Coursera.course.get("id");if(pilotSessions[sessionId]&&pilotSessions[sessionId].start_date&&pilotSessions[sessionId].end_date)Coursera.course.set("startDate",new Date(pilotSessions[sessionId].start_date)),Coursera.course.set("endDate",new Date(pilotSessions[sessionId].end_date)),Coursera.course.trigger("dateSet");else self.getSessionStartAndEndDates().then(function(data){var startDate=new Date(data.elements[0].startDate),endDate=new Date(data.elements[0].endDate);Coursera.course.set("startDate",startDate),Coursera.course.set("endDate",endDate),Coursera.course.trigger("dateSet")},function(err){Coursera.course.trigger("datesNotFound")}).done()}else Coursera.course.trigger("dateSet")},showTabCallout:function(){var start=Coursera.course.get("startDate"),calloutStartDate=new Date("2014/06/09");return this.isTestSubject()&&this.isSessionWithSparkSurveyQuestions()&&start&&start>=calloutStartDate}};return AbUtils});